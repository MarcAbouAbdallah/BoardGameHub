package ca.mcgill.ecse321.boardgamehub.service;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;

import java.sql.Date;
import java.util.Optional;

import ca.mcgill.ecse321.boardgamehub.exception.BoardGameHubException;
import ca.mcgill.ecse321.boardgamehub.model.*;
import ca.mcgill.ecse321.boardgamehub.repo.BorrowRequestRepository;
import ca.mcgill.ecse321.boardgamehub.repo.PlayerRepository;
import ca.mcgill.ecse321.boardgamehub.repo.GameCopyRepository;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.http.HttpStatus;

@SpringBootTest
public class BorrowingServiceTests {

    @Mock
    private BorrowRequestRepository mockBorrowRequestRepo;
    
    @Mock
    private PlayerRepository mockPlayerRepo;
    
    @Mock
    private GameCopyRepository mockGameCopyRepo;
    
    @InjectMocks
    private BorrowingService borrowingService;

    private static final int VALID_REQUESTER_ID = 1;
    private static final int VALID_REQUESTEE_ID = 2;
    private static final int VALID_GAME_COPY_ID = 3;
    private static final int VALID_BORROW_REQUEST_ID = 100;
    
    private static final String TEST_COMMENT = "Request to borrow this game.";
    private static final Date START_DATE = Date.valueOf("2025-02-15");
    private static final Date END_DATE = Date.valueOf("2025-02-20");
    
    private Player requester;
    private Player requestee;
    private GameCopy gameCopy;
    private BorrowRequest borrowRequest;

    @BeforeEach
    public void setup() {
        MockitoAnnotations.openMocks(this);

        requester = new Player("Alice", "alice@example.com", "password123", false);
        requester.setId(VALID_REQUESTER_ID);
        
        requestee = new Player("Bob", "bob@example.com", "securePass", true);
        requestee.setId(VALID_REQUESTEE_ID);

        gameCopy = new GameCopy();
        gameCopy.setId(VALID_GAME_COPY_ID);
        
        borrowRequest = new BorrowRequest(requester, requestee, gameCopy, TEST_COMMENT, START_DATE, END_DATE);
        borrowRequest.setId(VALID_BORROW_REQUEST_ID);
        borrowRequest.setStatus(BorrowStatus.PENDING);
    }

    /**Test Case1: Successfully create a borrow request **/
    @Test
    public void testCreateBorrowRequest_Success() {
        when(mockPlayerRepo.findById(VALID_REQUESTER_ID)).thenReturn(Optional.of(requester));
        when(mockPlayerRepo.findById(VALID_REQUESTEE_ID)).thenReturn(Optional.of(requestee));
        when(mockGameCopyRepo.findById(VALID_GAME_COPY_ID)).thenReturn(Optional.of(gameCopy));
        when(mockBorrowRequestRepo.save(any(BorrowRequest.class))).thenReturn(borrowRequest);

        BorrowRequest createdRequest = borrowingService.createBorrowRequest(
                VALID_REQUESTER_ID, VALID_REQUESTEE_ID, VALID_GAME_COPY_ID, TEST_COMMENT, START_DATE, END_DATE
        );

        assertNotNull(createdRequest);
        assertEquals(TEST_COMMENT, createdRequest.getComment());
        assertEquals(BorrowStatus.PENDING, createdRequest.getStatus());
        verify(mockBorrowRequestRepo, times(1)).save(any(BorrowRequest.class));
    }

    /** Test Case2: Cannot borrow from self **/
    @Test
    public void testCreateBorrowRequest_FailsIfSamePlayer() {
        when(mockPlayerRepo.findById(VALID_REQUESTER_ID)).thenReturn(Optional.of(requester));

        BoardGameHubException exception = assertThrows(BoardGameHubException.class, () ->
                borrowingService.createBorrowRequest(VALID_REQUESTER_ID, VALID_REQUESTER_ID, VALID_GAME_COPY_ID, TEST_COMMENT, START_DATE, END_DATE)
        );

        assertEquals("You cannot borrow a game from yourself.", exception.getMessage());
    }

    /**Test Case3: Request fails if requester not found **/
    @Test
    public void testCreateBorrowRequest_FailsIfRequesterNotFound() {
        when(mockPlayerRepo.findById(VALID_REQUESTER_ID)).thenReturn(Optional.empty());

        BoardGameHubException exception = assertThrows(BoardGameHubException.class, () ->
                borrowingService.createBorrowRequest(VALID_REQUESTER_ID, VALID_REQUESTEE_ID, VALID_GAME_COPY_ID, TEST_COMMENT, START_DATE, END_DATE)
        );

        assertEquals(HttpStatus.NOT_FOUND, exception.getStatus());
        assertEquals("Requester not found.", exception.getMessage());
    }

    /**Test Case5: Successfully approve a borrow request **/
    @Test
    public void testApproveBorrowRequest_Success() {
        when(mockBorrowRequestRepo.findById(VALID_BORROW_REQUEST_ID)).thenReturn(Optional.of(borrowRequest));

        BorrowRequest approvedRequest = borrowingService.approveBorrowRequest(VALID_BORROW_REQUEST_ID);

        assertEquals(BorrowStatus.ACCEPTED, approvedRequest.getStatus());
        verify(mockBorrowRequestRepo, times(1)).save(borrowRequest);
    }

    /**Test Case4: Cannot approve a non-existing request **/
    @Test
    public void testApproveBorrowRequest_FailsIfNotFound() {
        when(mockBorrowRequestRepo.findById(VALID_BORROW_REQUEST_ID)).thenReturn(Optional.empty());

        BoardGameHubException exception = assertThrows(BoardGameHubException.class, () ->
                borrowingService.approveBorrowRequest(VALID_BORROW_REQUEST_ID)
        );

        assertEquals(HttpStatus.NOT_FOUND, exception.getStatus());
        assertEquals("Borrow request not found.", exception.getMessage());
    }

    /**Test Case6: Successfully reject a borrow request **/
    @Test
    public void testRejectBorrowRequest_Success() {
        when(mockBorrowRequestRepo.findById(VALID_BORROW_REQUEST_ID)).thenReturn(Optional.of(borrowRequest));

        BorrowRequest rejectedRequest = borrowingService.rejectBorrowRequest(VALID_BORROW_REQUEST_ID);

        assertEquals(BorrowStatus.DECLINED, rejectedRequest.getStatus());
        verify(mockBorrowRequestRepo, times(1)).save(borrowRequest);
    }

    /**Test Case7: Successfully delete a borrow request **/
    @Test
    public void testDeleteBorrowRequest_Success() {
        when(mockBorrowRequestRepo.findById(VALID_BORROW_REQUEST_ID)).thenReturn(Optional.of(borrowRequest));

        borrowingService.deleteBorrowRequest(VALID_BORROW_REQUEST_ID);
        verify(mockBorrowRequestRepo, times(1)).delete(borrowRequest);
    }

    /**Test Case 8: Cannot delete a non-existing request **/
    @Test
    public void testDeleteBorrowRequest_FailsIfNotFound() {
        when(mockBorrowRequestRepo.findById(VALID_BORROW_REQUEST_ID)).thenReturn(Optional.empty());

        BoardGameHubException exception = assertThrows(BoardGameHubException.class, () ->
                borrowingService.deleteBorrowRequest(VALID_BORROW_REQUEST_ID)
        );

        assertEquals(HttpStatus.NOT_FOUND, exception.getStatus());
        assertEquals("Borrow request not found.", exception.getMessage());
    }
}
